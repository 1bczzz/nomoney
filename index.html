<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極簡黑白帳本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f9f9f9;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .sarcasm-in {
            animation: sarcasm-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes sarcasm-in {
            0% { opacity: 0; transform: translateY(-40px) scale(0.8) rotate(-2deg); filter: blur(10px); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); filter: blur(0); }
        }

        .sarcasm-out {
            animation: sarcasm-out 0.5s ease forwards;
        }

        @keyframes sarcasm-out {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-20px) scale(0.95); filter: blur(5px); }
        }

        .pin-dot {
            transition: all 0.3s ease;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen">

    <div id="app" class="w-full max-w-md bg-white min-h-screen shadow-2xl relative flex flex-col overflow-hidden border-x border-gray-100">
        <!-- 內容將由 JavaScript 動態渲染 -->
    </div>

    <script>
        // --- 核心數據狀態 ---
        let state = {
            view: 'lock', // lock, list, add, stats, settings
            isLocked: true,
            pin: '',
            savedPin: localStorage.getItem('mini_account_pin') || null,
            isSettingPin: !localStorage.getItem('mini_account_pin'),
            transactions: JSON.parse(localStorage.getItem('mini_account_tx') || '[]'),
            categories: {
                expense: ['餐飲', '交通', '購物', '娛樂', '居住'],
                income: ['薪資', '獎金', '投資', '零用錢']
            },
            categoryColors: {
                '餐飲': '#000000', '交通': '#444444', '購物': '#666666', '娛樂': '#888888', '居住': '#AAAAAA',
                '薪資': '#000000', '獎金': '#555555', '投資': '#888888', '零用錢': '#BBBBBB'
            },
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            // 新增帳目表單狀態
            form: {
                type: 'expense',
                amount: '0',
                category: '',
                date: new Date().toISOString().split('T')[0],
                note: '',
                paymentMethod: 'cash',
                formula: ''
            }
        };

        const sarcasmQuotes = [
            "錢沒有不見，只是變成了你沒用的樣子。",
            "你的錢包正在對你發出最後通牒。",
            "這筆錢花下去，距離財富自由又遠了十年。",
            "下個月的你看到這筆帳單會哭，但現在的你不在乎。",
            "你的帳戶餘額正在模仿你的智商：持續下降。",
            "恭喜你，離成為窮光蛋又近了一步！",
            "那是錢離開你時發出的哭聲，你有聽到嗎？",
            "你不是在消費，是在給銀行打工。",
            "這個價格，建議你去搶可能比較快。",
            "買的時候很爽，看帳單的時候很慘。"
        ];

        // --- 渲染引擎 ---
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'lock') {
                app.innerHTML = renderLockView();
            } else {
                app.innerHTML = `
                    ${renderHeader()}
                    <main class="flex-1 overflow-y-auto hide-scrollbar pb-32">
                        ${state.view === 'list' ? renderListView() : ''}
                        ${state.view === 'add' ? renderAddView() : ''}
                        ${state.view === 'stats' ? renderStatsView() : ''}
                        ${state.view === 'settings' ? renderSettingsView() : ''}
                    </main>
                    ${state.view !== 'add' ? renderNav() : ''}
                `;
            }
            lucide.createIcons();
            if (state.view === 'stats') initChart();
        }

        // --- 各個畫面模板 ---
        function renderLockView() {
            const title = state.isSettingPin ? "設定存取密碼" : "安全驗證";
            const dots = [0, 1, 2, 3].map(i => `
                <div class="w-3 h-3 rounded-full border-2 border-white/20 pin-dot ${state.pin.length > i ? 'bg-white border-white scale-125' : ''}"></div>
            `).join('');

            return `
                <div class="h-screen bg-black flex flex-col items-center justify-center p-8 text-white">
                    <div class="mb-12 text-center">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="${state.isSettingPin ? 'shield-check' : 'lock'}" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-xl font-black tracking-tighter">${title}</h2>
                        <p class="text-[10px] text-gray-500 mt-2 font-bold uppercase tracking-widest">請輸入 4 位數密碼</p>
                    </div>
                    <div class="flex space-x-4 mb-16">${dots}</div>
                    <div class="grid grid-cols-3 gap-8 w-full max-w-[280px]">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, 'del'].map(n => {
                            if (n === '') return '<div></div>';
                            if (n === 'del') return `<button onclick="handlePin('back')" class="w-full aspect-square flex items-center justify-center text-gray-500"><i data-lucide="delete"></i></button>`;
                            return `<button onclick="handlePin('${n}')" class="w-full aspect-square rounded-full flex items-center justify-center text-2xl font-black active:bg-white active:text-black">${n}</button>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            if (state.view === 'add') return '';
            let title = "我的帳本";
            if (state.view === 'stats') title = "消費分析";
            if (state.view === 'settings') title = "系統設定";

            return `
                <header class="p-5 flex justify-between items-center bg-white shrink-0">
                    <h1 class="text-2xl font-black tracking-tighter">${title}</h1>
                    ${state.view === 'list' ? `
                        <div class="bg-gray-50 px-3 py-1.5 rounded-full flex items-center space-x-1">
                            <button onclick="changeMonth(-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <span class="text-[10px] font-black">${state.currentYear}.${String(state.currentMonth + 1).padStart(2, '0')}</span>
                            <button onclick="changeMonth(1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    ` : ''}
                </header>
            `;
        }

        function renderListView() {
            const stats = getStats();
            const filtered = state.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === state.currentMonth && d.getFullYear() === state.currentYear;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            return `
                <div class="px-5 space-y-6">
                    <div class="bg-black text-white p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-[10px] opacity-40 font-black uppercase tracking-widest mb-1">本月結餘</p>
                            <p class="text-4xl font-black">$${(stats.income - stats.expense).toLocaleString()}</p>
                            <div class="mt-6 grid grid-cols-2 gap-4 border-t border-white/10 pt-5">
                                <div>
                                    <p class="text-[9px] opacity-40 font-bold mb-1 uppercase tracking-tighter">收入</p>
                                    <p class="text-sm font-black text-emerald-400">+$${stats.income.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] opacity-40 font-bold mb-1 uppercase tracking-tighter">支出</p>
                                    <p class="text-sm font-black text-red-400">-$${stats.expense.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        <div class="absolute -right-8 -bottom-8 opacity-5 rotate-12"><i data-lucide="wallet" style="width:120px;height:120px"></i></div>
                    </div>

                    <button onclick="navigate('add')" class="w-full flex items-center justify-center space-x-3 p-6 bg-black text-white rounded-[2rem] shadow-xl active:scale-[0.98] transition-all group">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center group-hover:rotate-90 transition-transform"><i data-lucide="plus" class="w-5 h-5"></i></div>
                        <span class="text-sm font-black tracking-widest uppercase">新增一筆帳目</span>
                    </button>

                    <div class="space-y-4">
                        <p class="text-[10px] font-black text-gray-300 uppercase tracking-widest ml-1">最近帳目</p>
                        ${filtered.length === 0 ? '<div class="text-center py-12 text-gray-300 font-bold text-sm">尚未有任何紀錄</div>' : 
                            filtered.map(t => `
                                <div class="flex items-center justify-between p-4 bg-white border border-gray-50 rounded-3xl active:scale-95 transition-all">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-11 h-11 rounded-2xl flex items-center justify-center text-white font-black text-lg" style="background-color: ${state.categoryColors[t.category] || '#000'}">${t.category[0]}</div>
                                        <div>
                                            <div class="flex items-center space-x-2"><p class="font-black text-sm">${t.category}</p></div>
                                            <p class="text-[10px] text-gray-400 font-bold uppercase">${t.date.split('-').slice(1).join('/')} ${t.note ? '· ' + t.note : ''}</p>
                                        </div>
                                    </div>
                                    <p class="font-black ${t.type === 'expense' ? 'text-black' : 'text-emerald-500'}">${t.type === 'expense' ? '-' : '+'}$${parseFloat(t.amount).toLocaleString()}</p>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        function renderAddView() {
            const f = state.form;
            return `
                <div class="fixed inset-0 bg-white z-[200] flex flex-col animate-in slide-in-from-bottom duration-300">
                    <div class="p-6 pt-12 space-y-6 flex-1 overflow-y-auto hide-scrollbar">
                        <div class="flex justify-between items-center">
                            <button onclick="navigate('list')" class="p-3 bg-gray-50 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
                            <div class="flex bg-gray-100 p-1 rounded-full w-36 relative h-10 items-center">
                                <div class="absolute h-8 w-[68px] bg-black rounded-full transition-all duration-300" style="left: ${f.type === 'expense' ? '4px' : 'calc(100% - 72px)'}"></div>
                                <button onclick="setFormType('expense')" class="relative z-10 flex-1 text-xs font-black ${f.type === 'expense' ? 'text-white' : 'text-gray-400'}">支出</button>
                                <button onclick="setFormType('income')" class="relative z-10 flex-1 text-xs font-black ${f.type === 'income' ? 'text-white' : 'text-gray-400'}">收入</button>
                            </div>
                            <button onclick="saveTx()" class="p-3 bg-black text-white rounded-full active:scale-90 shadow-lg"><i data-lucide="check" class="w-6 h-6"></i></button>
                        </div>
                        <div class="text-right py-4">
                            <p class="text-sm text-gray-300 font-mono h-5 mb-1">${f.formula || ''}</p>
                            <div class="text-7xl font-black tracking-tighter truncate leading-tight"><span class="text-3xl mr-1 text-gray-200">$</span>${f.amount}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-50 rounded-2xl px-5 py-4 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-3 text-gray-400"></i><input type="date" value="${f.date}" onchange="state.form.date = this.value" class="bg-transparent text-sm font-black outline-none w-full" /></div>
                            <div class="bg-gray-50 rounded-2xl px-5 py-4 flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-3 text-gray-400"></i><input type="text" placeholder="備註..." value="${f.note}" oninput="state.form.note = this.value" class="bg-transparent text-sm font-black outline-none w-full" /></div>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-2">
                            ${state.categories[f.type].map(cat => `
                                <button onclick="setCategory('${cat}')" class="px-5 py-3 rounded-full border text-xs font-black transition-all ${f.category === cat ? 'bg-black text-white border-black' : 'bg-white text-gray-400 border-gray-100'}">${cat}</button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 grid grid-cols-4 gap-2 pb-10">
                        ${['7','8','9','AC','4','5','6','DEL','1','2','3','+','00','0','.','='].map(k => `
                            <button onclick="handleKeypad('${k}')" class="h-16 rounded-2xl flex items-center justify-center text-xl font-black shadow-sm active:scale-95 bg-white ${k === '=' ? 'bg-black text-white' : ''}">${k === 'DEL' ? '<i data-lucide="delete"></i>' : k}</button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderStatsView() {
            const stats = getStats();
            return `
                <div class="p-6 space-y-8 animate-in fade-in duration-500">
                    <h2 class="text-xl font-black">消費結構</h2>
                    <div class="h-64 flex justify-center items-center relative">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="space-y-2">
                        ${Object.entries(stats.byCategory).sort((a,b) => b[1] - a[1]).map(([cat, val]) => `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-3xl">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 rounded-full" style="background-color: ${state.categoryColors[cat]}"></div>
                                    <span class="text-xs font-black">${cat}</span>
                                </div>
                                <span class="text-xs font-black">$${val.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSettingsView() {
            return `
                <div class="p-6 space-y-8">
                    <section class="space-y-4">
                        <h3 class="text-[10px] font-black text-gray-300 uppercase tracking-widest">系統管理</h3>
                        <div class="space-y-2">
                            <button onclick="exportCSV()" class="w-full flex items-center justify-between p-5 bg-black text-white rounded-[1.5rem]">
                                <span class="text-xs font-black">導出 CSV 報表</span>
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="changePin()" class="w-full flex items-center justify-between p-5 bg-white border border-gray-100 rounded-[1.5rem]">
                                <span class="text-xs font-black">變更 PIN 密碼</span>
                                <i data-lucide="key-round" class="w-4 h-4"></i>
                            </button>
                            <button onclick="clearData()" class="w-full flex items-center justify-between p-5 bg-red-50 text-red-500 rounded-[1.5rem]">
                                <span class="text-xs font-black">清除所有資料</span>
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </section>
                </div>
            `;
        }

        function renderNav() {
            return `
                <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white/80 backdrop-blur-xl border-t border-gray-50 flex z-50 max-w-md mx-auto">
                    <button onclick="navigate('list')" class="flex-1 flex flex-col items-center justify-center space-y-1 ${state.view === 'list' ? 'text-black' : 'text-gray-300'}"><i data-lucide="list" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase tracking-tighter">明細</span></button>
                    <button onclick="navigate('stats')" class="flex-1 flex flex-col items-center justify-center space-y-1 ${state.view === 'stats' ? 'text-black' : 'text-gray-300'}"><i data-lucide="pie-chart" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase tracking-tighter">分析</span></button>
                    <button onclick="navigate('settings')" class="flex-1 flex flex-col items-center justify-center space-y-1 ${state.view === 'settings' ? 'text-black' : 'text-gray-300'}"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase tracking-tighter">設定</span></button>
                </nav>
            `;
        }

        // --- 功能邏輯 ---

        function handlePin(val) {
            if (val === 'back') {
                state.pin = state.pin.slice(0, -1);
            } else if (state.pin.length < 4) {
                state.pin += val;
            }

            if (state.pin.length === 4) {
                if (state.isSettingPin) {
                    localStorage.setItem('mini_account_pin', state.pin);
                    state.savedPin = state.pin;
                    state.isSettingPin = false;
                    state.isLocked = false;
                    state.view = 'list';
                } else {
                    if (state.pin === state.savedPin) {
                        state.isLocked = false;
                        state.view = 'list';
                    } else {
                        state.pin = '';
                        alert("密碼錯誤！");
                    }
                }
            }
            render();
        }

        function navigate(view) {
            state.view = view;
            if (view === 'add') resetForm();
            render();
        }

        function changeMonth(delta) {
            let d = new Date(state.currentYear, state.currentMonth + delta);
            state.currentMonth = d.getMonth();
            state.currentYear = d.getFullYear();
            render();
        }

        function setFormType(type) {
            state.form.type = type;
            state.form.category = '';
            render();
        }

        function setCategory(cat) {
            state.form.category = cat;
            render();
        }

        function handleKeypad(k) {
            let f = state.form;
            if (/\d/.test(k) || k === '00') {
                f.amount = f.amount === '0' ? k : f.amount + k;
            } else if (k === '.') {
                if (!f.amount.includes('.')) f.amount += '.';
            } else if (k === 'AC') {
                f.amount = '0';
                f.formula = '';
            } else if (k === 'DEL') {
                f.amount = f.amount.length > 1 ? f.amount.slice(0, -1) : '0';
            } else if (k === '+') {
                f.formula = f.amount + ' +';
                f.prevAmount = f.amount;
                f.amount = '0';
            } else if (k === '=') {
                if (f.formula.includes('+')) {
                    f.amount = String(parseFloat(f.prevAmount) + parseFloat(f.amount));
                    f.formula = '';
                }
            }
            render();
        }

        function saveTx() {
            if (parseFloat(state.form.amount) <= 0) return;
            const newTx = {
                id: Date.now(),
                ...state.form,
                category: state.form.category || (state.form.type === 'expense' ? state.categories.expense[0] : state.categories.income[0])
            };
            state.transactions.unshift(newTx);
            localStorage.setItem('mini_account_tx', JSON.stringify(state.transactions));
            
            if (state.form.type === 'expense') triggerSarcasm();
            navigate('list');
        }

        function triggerSarcasm() {
            const quote = sarcasmQuotes[Math.floor(Math.random() * sarcasmQuotes.length)];
            const div = document.createElement('div');
            div.className = "fixed top-8 left-5 right-5 z-[1000] p-6 rounded-[2.5rem] shadow-2xl flex items-center space-x-4 bg-black text-white sarcasm-in";
            div.innerHTML = `
                <div class="p-3 bg-white/10 rounded-2xl shrink-0"><i data-lucide="ghost" class="text-white animate-pulse"></i></div>
                <div class="flex-1">
                    <p class="text-[10px] text-white/40 font-black uppercase tracking-[0.2em] mb-1">給你的溫馨提示</p>
                    <p class="text-sm font-black leading-tight tracking-tighter">${quote}</p>
                </div>
            `;
            document.body.appendChild(div);
            lucide.createIcons();
            
            setTimeout(() => {
                div.classList.replace('sarcasm-in', 'sarcasm-out');
                setTimeout(() => div.remove(), 500);
            }, 3500);
        }

        function getStats() {
            const stats = { income: 0, expense: 0, byCategory: {} };
            state.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === state.currentMonth && d.getFullYear() === state.currentYear;
            }).forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.type === 'income') stats.income += amt;
                else {
                    stats.expense += amt;
                    stats.byCategory[t.category] = (stats.byCategory[t.category] || 0) + amt;
                }
            });
            return stats;
        }

        function resetForm() {
            state.form = {
                type: 'expense',
                amount: '0',
                category: '',
                date: new Date().toISOString().split('T')[0],
                note: '',
                paymentMethod: 'cash',
                formula: ''
            };
        }

        function initChart() {
            const stats = getStats();
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const data = Object.entries(stats.byCategory);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        data: data.map(d => d[1]),
                        backgroundColor: data.map(d => state.categoryColors[d[0]] || '#000'),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });
        }

        function exportCSV() {
            if (state.transactions.length === 0) return;
            const headers = ["日期", "類型", "項目", "金額", "備註"];
            const rows = state.transactions.map(t => [t.date, t.type === 'expense' ? '支出' : '收入', t.category, t.amount, t.note]);
            const csv = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `帳本_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }

        function changePin() {
            const p = prompt("請輸入新密碼（4位數）：");
            if (p && p.length === 4) {
                localStorage.setItem('mini_account_pin', p);
                state.savedPin = p;
                alert("密碼已更新");
            }
        }

        function clearData() {
            if (confirm("確定要清除所有帳目嗎？此動作無法復原。")) {
                state.transactions = [];
                localStorage.setItem('mini_account_tx', '[]');
                render();
            }
        }

        // 初始化
        render();
    </script>
</body>
</html>


