<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Elite Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @font-face {
            font-family: 'PingFang TC';
            font-weight: 400 900;
            src: local('PingFangTC-Semibold'), local('PingFangTC-Bold'), local('PingFangTC-Medium');
        }

        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background-color: #fcfcfd; 
            color: #1a1c1e; 
            overflow: hidden; 
            font-weight: 600; 
        }
        
        .font-black-bold { font-weight: 900 !important; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .page-container { height: calc(100vh - 90px); overflow-y: auto; padding-bottom: 80px; }
        
        .nav-btn { color: #cbd5e1; transition: all 0.3s; font-size: 0.75rem; font-weight: 900; display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; cursor: pointer; }
        .nav-btn.active { color: #1a1c1e; transform: scale(1.05); }
        
        .calc-btn { background: white; height: 58px; border-radius: 12px; font-size: 1.15rem; font-weight: 900; display: flex; align-items: center; justify-content: center; transition: all 0.1s; border: 1px solid #f1f5f9; cursor: pointer; }
        .calc-btn:active { transform: scale(0.95); background: #f8fafc; }
        .calc-btn.op { background: #f8fafc; color: #1e293b; border: none; font-size: 1.3rem; }
        .calc-btn.action { background: #000; color: #fff; border: none; font-size: 1.1rem; }
        .calc-btn.danger { color: #ef4444; font-size: 0.9rem; }

        .category-chip { padding: 12px 16px; border-radius: 16px; font-size: 0.85rem; font-weight: 900; background: #f1f5f9; border: 2px solid transparent; cursor: pointer; white-space: nowrap; transition: all 0.2s; color: #64748b; }
        .date-divider { position: sticky; top: -1px; z-index: 10; background: rgba(252, 252, 253, 0.9); backdrop-filter: blur(8px); }

        .hidden { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 900; border-radius: 10px; cursor: pointer; }
        .calendar-day.active { background: #000; color: #fff; }
        .calendar-day.today { border: 2px solid #000; }
        .calendar-day.other-month { opacity: 0.2; }

        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .pin-dot.filled { background-color: #0f172a; border-color: #0f172a; transform: scale(1.2); }

        .color-input { width: 0; height: 0; visibility: hidden; position: absolute; }
    </style>
</head>
<body class="antialiased">

    <!-- å…¨åŸŸå¯†ç¢¼é©—è­‰é– -->
    <div id="authScreen" class="fixed inset-0 z-[500] bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-12">
            <h2 id="authTitle" class="text-4xl font-black-bold mb-3 text-slate-900 tracking-tighter">æ­¡è¿å›ä¾†</h2>
            <p id="authSub" class="text-slate-400 text-xs font-black tracking-[0.2em] uppercase">è«‹è¼¸å…¥ 4 ä½è§£é–å¯†ç¢¼</p>
            <div id="pinDisplay" class="flex gap-6 mt-12 justify-center">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-5 w-full max-w-xs">
            <button class="calc-btn" onclick="inputAuth(1)">1</button><button class="calc-btn" onclick="inputAuth(2)">2</button><button class="calc-btn" onclick="inputAuth(3)">3</button>
            <button class="calc-btn" onclick="inputAuth(4)">4</button><button class="calc-btn" onclick="inputAuth(5)">5</button><button class="calc-btn" onclick="inputAuth(6)">6</button>
            <button class="calc-btn" onclick="inputAuth(7)">7</button><button class="calc-btn" onclick="inputAuth(8)">8</button><button class="calc-btn" onclick="inputAuth(9)">9</button>
            <button class="calc-btn op text-xs" onclick="clearAuth()">æ¸…é™¤</button><button class="calc-btn" onclick="inputAuth(0)">0</button>
            <button class="calc-btn bg-black text-white font-black" onclick="submitAuth()">ç¢ºèª</button>
        </div>
    </div>

    <!-- æ›´æ”¹å¯†ç¢¼å½ˆçª— -->
    <div id="changePinModal" class="fixed inset-0 z-[400] hidden bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8 w-full max-w-xs">
            <div class="flex justify-end mb-4"><button onclick="closePinModal()" class="text-slate-300 font-black">âœ• é—œé–‰</button></div>
            <h2 id="changePinTitle" class="text-2xl font-black-bold mb-2 text-slate-900 tracking-tight">é©—è­‰èˆŠå¯†ç¢¼</h2>
            <p id="changePinSub" class="text-slate-400 text-[10px] font-black tracking-widest uppercase mb-8">è«‹è¼¸å…¥ç•¶å‰çš„ 4 ä½æ•¸å­—</p>
            <div id="changePinDisplay" class="flex gap-6 justify-center mb-12">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="grid grid-cols-3 gap-5 w-full">
                <button class="calc-btn" onclick="inputChangePin(1)">1</button><button class="calc-btn" onclick="inputChangePin(2)">2</button><button class="calc-btn" onclick="inputChangePin(3)">3</button>
                <button class="calc-btn" onclick="inputChangePin(4)">4</button><button class="calc-btn" onclick="inputChangePin(5)">5</button><button class="calc-btn" onclick="inputChangePin(6)">6</button>
                <button class="calc-btn" onclick="inputChangePin(7)">7</button><button class="calc-btn" onclick="inputChangePin(8)">8</button><button class="calc-btn" onclick="inputChangePin(9)">9</button>
                <button class="calc-btn op text-xs" onclick="clearChangePin()">æ¸…é™¤</button><button class="calc-btn" onclick="inputChangePin(0)">0</button>
                <button id="changePinActionBtn" class="calc-btn bg-black text-white font-black" onclick="submitChangePinStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>

    <!-- é¡åˆ¥ç®¡ç†å½ˆçª— -->
    <div id="categoryManageModal" class="fixed inset-0 z-[450] hidden flex items-center justify-center bg-black/40 backdrop-blur-md p-6">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 id="catManageTitle" class="text-xl font-black-bold">ç®¡ç†é¡åˆ¥</h3>
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button id="manageTabEx" onclick="toggleManageType('expense')" class="px-4 py-2 rounded-lg text-[10px] font-black bg-white shadow-sm">æ”¯å‡º</button>
                    <button id="manageTabIn" onclick="toggleManageType('income')" class="px-4 py-2 rounded-lg text-[10px] font-black text-slate-400">æ”¶å…¥</button>
                </div>
            </div>
            <div class="flex gap-2 mb-6">
                <input id="newCatInput" type="text" placeholder="è¼¸å…¥åç¨±" class="flex-1 bg-slate-100 border-none rounded-2xl px-4 py-3 text-sm font-black focus:ring-2 focus:ring-black outline-none">
                <button onclick="addNewCategory()" class="bg-black text-white w-12 h-12 rounded-2xl flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button>
            </div>
            <div id="catManageList" class="flex-1 overflow-y-auto space-y-3 scrollbar-hide"></div>
            <button onclick="closeCategoryManage()" class="mt-6 w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-black text-xs uppercase">å®Œæˆä¸¦é—œé–‰</button>
        </div>
    </div>

    <!-- è‡ªå®šç¾©å°è©±å½ˆçª— -->
    <div id="customDialog" class="fixed inset-0 z-[600] hidden flex items-center justify-center bg-black/30 backdrop-blur-sm p-6">
        <div class="bg-white rounded-[2rem] p-8 shadow-2xl max-w-xs w-full text-center">
            <div id="dialogIcon" class="mb-4 flex justify-center"></div>
            <h3 id="dialogTitle" class="text-xl font-black-bold mb-2">æ¨™é¡Œ</h3>
            <p id="dialogMsg" class="text-slate-500 text-sm font-medium mb-6"></p>
            <div class="flex flex-col gap-2">
                <button id="dialogConfirmBtn" class="w-full py-4 bg-black text-white rounded-2xl font-black text-sm">ç¢ºå®š</button>
                <button id="dialogCancelBtn" onclick="closeDialog()" class="w-full py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¡Œäº‹æ›†å½ˆçª— -->
    <div id="calendarModal" class="fixed inset-0 z-[450] hidden flex items-center justify-center bg-black/30 backdrop-blur-sm p-6">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="p-2 bg-slate-50 rounded-full"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <span id="calendarMonthStr" class="text-sm font-black uppercase tracking-widest">2024å¹´3æœˆ</span>
                <button onclick="changeMonth(1)" class="p-2 bg-slate-50 rounded-full"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>
            <div class="grid grid-cols-7 gap-1 mb-2 text-[9px] font-black text-slate-300 text-center">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendarDays" class="calendar-grid mb-6"></div>
            <button onclick="closeCalendar()" class="w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-black text-xs uppercase">é—œé–‰</button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹ -->
    <div id="mainApp" class="hidden h-screen flex flex-col">
        <div class="flex-1 relative">
            <!-- é¦–é  -->
            <section id="page-home" class="page-container p-6">
                <div class="flex flex-col items-center mb-8 mt-4"><h1 class="text-3xl font-black-bold tracking-tight text-center">ä½ ä»¥ç‚ºä½ å¾ˆæœ‰éŒ¢å—ğŸ’¸</h1></div>
                
                <!-- è³‡ç”¢å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2.5rem] p-8 mb-6 shadow-2xl text-white">
                    <p class="text-[10px] opacity-60 font-black uppercase tracking-widest mb-2">ç•¶å‰ç¸½è³‡ç”¢</p>
                    <h2 id="totalBalance" class="text-5xl font-black-bold mb-8 tracking-tighter">$ 0</h2>
                    
                    <!-- åˆ†é¡çµé¤˜ -->
                    <div class="flex gap-6 mb-8 border-t border-white/10 pt-6">
                        <div class="flex-1">
                            <p class="text-[10px] opacity-40 font-black mb-1 uppercase tracking-wider">ç¾é‡‘çµé¤˜</p>
                            <p id="balance-cash" class="text-lg font-black-bold text-slate-100">$ 0</p>
                        </div>
                        <div class="w-px h-10 bg-white/10"></div>
                        <div class="flex-1">
                            <p class="text-[10px] opacity-40 font-black mb-1 uppercase tracking-wider">å¡ç‰‡çµé¤˜</p>
                            <p id="balance-card" class="text-lg font-black-bold text-slate-100">$ 0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                            <p class="text-[10px] opacity-40 font-black mb-1 uppercase">ç¸½æ”¶å…¥</p>
                            <p id="allIncome" class="text-xl font-black-bold text-emerald-400">$ 0</p>
                        </div>
                        <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                            <p class="text-[10px] opacity-40 font-black mb-1 uppercase">ç¸½æ”¯å‡º</p>
                            <p id="allExpense" class="text-xl font-black-bold text-slate-100">$ 0</p>
                        </div>
                    </div>
                </div>

                <button onclick="openRecordModal()" class="w-full bg-black text-white rounded-[2.5rem] py-6 mb-8 flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i><span class="font-black text-xl">æ–°å¢æ”¶æ”¯ç´€éŒ„</span>
                </button>
                <div class="flex justify-between items-center mb-6 px-1">
                    <h3 class="text-xl font-black-bold">äº¤æ˜“æ˜ç´°</h3>
                    <span class="px-3 py-1 rounded-full bg-slate-100 text-[10px] font-black" id="txCount">0</span>
                </div>
                <div id="homeTransactionList" class="space-y-8 pb-10"></div>
            </section>

            <!-- å ±è¡¨ -->
            <section id="page-analysis" class="page-container p-6 hidden">
                <h1 class="text-3xl font-black-bold mb-8 text-center">å ±è¡¨åˆ†æ</h1>
                <div class="glass rounded-[3rem] p-8 shadow-sm mb-6 flex flex-col items-center">
                    <div class="w-56 h-56 relative mb-8 flex items-center justify-center">
                        <canvas id="expenseChart"></canvas>
                        <div id="noDataText" class="absolute hidden text-slate-300 text-xs font-black">å°šç„¡æ•¸æ“š</div>
                    </div>
                    <div id="chartLegend" class="w-full space-y-2 text-sm font-black text-slate-600 uppercase"></div>
                </div>
            </section>

            <!-- è¨­å®š -->
            <section id="page-settings" class="page-container p-6 hidden">
                <h1 class="text-3xl font-black-bold mb-8">ç³»çµ±è¨­å®š</h1>
                <div class="space-y-6">
                    <div class="glass rounded-3xl p-6 shadow-sm space-y-3">
                        <button onclick="openCategoryManage()" class="w-full p-6 bg-slate-50 text-slate-900 rounded-2xl text-sm font-black text-left flex justify-between items-center transition-all active:scale-95">
                            ç®¡ç†æ”¶æ”¯é¡åˆ¥èˆ‡é¡è‰² <i data-lucide="palette" class="w-4 h-4 opacity-40"></i>
                        </button>
                        <button onclick="openPinModal()" class="w-full p-6 bg-slate-50 text-slate-900 rounded-2xl text-sm font-black text-left flex justify-between items-center transition-all active:scale-95">
                            æ›´æ”¹é–å±å¯†ç¢¼ <i data-lucide="lock" class="w-4 h-4 opacity-40"></i>
                        </button>
                        <button onclick="exportData()" class="w-full p-6 bg-slate-50 text-slate-900 rounded-2xl text-sm font-black text-left flex justify-between items-center transition-all active:scale-95">
                            è¼¸å‡ºæ‰€æœ‰è³‡æ–™ (JSON) <i data-lucide="download" class="w-4 h-4 opacity-40"></i>
                        </button>
                        <button onclick="startAuthFlow('reset_tx')" class="w-full p-6 bg-red-50 text-red-500 rounded-2xl text-sm font-black text-left flex justify-between items-center transition-all active:scale-95">
                            åˆªé™¤æ‰€æœ‰å¸³ç›®è³‡æ–™ <i data-lucide="trash-2" class="w-4 h-4 opacity-40"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <nav class="glass border-t border-slate-100 bg-white/95 pb-8">
            <div class="flex justify-around items-center h-20">
                <button onclick="switchPage('home')" id="nav-home" class="nav-btn active"><i data-lucide="wallet"></i><span>ä¸»é </span></button>
                <button onclick="switchPage('analysis')" id="nav-analysis" class="nav-btn"><i data-lucide="pie-chart"></i><span>å ±è¡¨</span></button>
                <button onclick="switchPage('settings')" id="nav-settings" class="nav-btn"><i data-lucide="settings"></i><span>è¨­å®š</span></button>
            </div>
        </nav>
    </div>

    <!-- è¨˜å¸³é¢æ¿ -->
    <div id="recordModal" class="fixed inset-0 z-[300] hidden flex items-end justify-center bg-black/40 backdrop-blur-md">
        <div class="bg-white w-full max-lg rounded-t-[4rem] p-8 shadow-2xl flex flex-col max-h-[95vh] overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex p-1 bg-slate-100 rounded-2xl">
                    <button id="tabEx" onclick="setRecType('expense')" class="px-8 py-3 rounded-xl text-xs font-black bg-white shadow-sm transition-all">æ”¯å‡º</button>
                    <button id="tabIn" onclick="setRecType('income')" class="px-8 py-3 rounded-xl text-xs font-black text-slate-400 transition-all">æ”¶å…¥</button>
                </div>
                <button onclick="closeRecordModal()" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full font-bold">âœ•</button>
            </div>
            <div class="text-right py-4 px-2 mb-4"><span class="text-5xl font-black-bold tracking-tighter truncate block">$ <span id="calcDisplay">0</span></span></div>
            <div class="flex-1 overflow-y-auto space-y-6 pb-6 scrollbar-hide">
                <div class="flex gap-4">
                    <div onclick="openCalendar()" class="flex-1 bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 flex items-center gap-3 cursor-pointer active:scale-95 transition-all">
                        <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i><span id="dateText" class="text-xs font-black text-slate-600">é¸æ“‡æ—¥æœŸ</span>
                    </div>
                    <div class="flex gap-2 flex-1">
                        <button onclick="setAccount('cash')" id="acc-cash" class="flex-1 py-4 rounded-2xl font-black text-xs">ç¾é‡‘</button>
                        <button onclick="setAccount('card')" id="acc-card" class="flex-1 py-4 rounded-2xl font-black text-xs">å¡ç‰‡</button>
                    </div>
                </div>
                <div id="categoryGrid" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide"></div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="grid grid-cols-3 col-span-3 gap-2">
                        <button class="calc-btn" onclick="calcInput('7')">7</button><button class="calc-btn" onclick="calcInput('8')">8</button><button class="calc-btn" onclick="calcInput('9')">9</button>
                        <button class="calc-btn" onclick="calcInput('4')">4</button><button class="calc-btn" onclick="calcInput('5')">5</button><button class="calc-btn" onclick="calcInput('6')">6</button>
                        <button class="calc-btn" onclick="calcInput('1')">1</button><button class="calc-btn" onclick="calcInput('2')">2</button><button class="calc-btn" onclick="calcInput('3')">3</button>
                        <button class="calc-btn op" onclick="calcInput('00')">00</button><button class="calc-btn" onclick="calcInput('0')">0</button><button class="calc-btn" onclick="calcInput('.')">.</button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button class="calc-btn op" onclick="calcOp('/')">/</button><button class="calc-btn op" onclick="calcOp('*')">*</button>
                        <button class="calc-btn op" onclick="calcOp('-')">-</button><button class="calc-btn op" onclick="calcOp('+')">+</button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <button class="calc-btn danger font-black" onclick="calcClearAll()">AC</button>
                    <button class="calc-btn op danger" onclick="calcBackspace()">Del</button>
                    <button id="mainSubmitBtn" class="calc-btn action font-black text-lg" onclick="handleMainSubmit()">å®Œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            pin: localStorage.getItem('app_pin_v21') || '',
            transactions: JSON.parse(localStorage.getItem('app_tx_v21')) || [],
            categories: JSON.parse(localStorage.getItem('app_cat_v21')) || {
                expense: [{ name: 'é¤é£²', color: '#1a1c1e' }, { name: 'äº¤é€š', color: '#64748b' }, { name: 'è³¼ç‰©', color: '#3b82f6' }],
                income: [{ name: 'è–ªè³‡', color: '#10b981' }, { name: 'çé‡‘', color: '#f59e0b' }]
            },
            currentRec: { id: null, type: 'expense', account: 'cash', category: 'é¤é£²', expr: '0', date: '' },
            manageType: 'expense',
            authMode: 'login',
            tempAuth: '',
            changePinStep: 1, 
            tempNewPin1: '',
            changePinInput: '',
            viewDate: new Date()
        };

        let chartInstance = null;

        window.onload = () => {
            lucide.createIcons();
            if(!state.pin) {
                state.authMode = 'login';
                document.getElementById('authTitle').innerText = "è¨­ç½®æ–°å¯†ç¢¼";
            }
            renderUI(); renderHomeRecords();
        };

        function save() { 
            localStorage.setItem('app_tx_v21', JSON.stringify(state.transactions)); 
            localStorage.setItem('app_pin_v21', state.pin);
            localStorage.setItem('app_cat_v21', JSON.stringify(state.categories));
        }

        // --- å¯†ç¢¼èˆ‡è§£é– ---
        function startAuthFlow(mode) {
            state.authMode = mode;
            state.tempAuth = '';
            document.getElementById('authTitle').innerText = mode === 'reset_tx' ? "è«‹è¼¸å…¥å¯†ç¢¼" : (state.pin ? "æ­¡è¿å›ä¾†" : "è¨­ç½®æ–°å¯†ç¢¼");
            document.getElementById('authScreen').classList.remove('hidden');
            updateDots('pinDisplay', '');
        }
        function inputAuth(n) { if(state.tempAuth.length < 4) { state.tempAuth += n; updateDots('pinDisplay', state.tempAuth); } }
        function clearAuth() { state.tempAuth = ''; updateDots('pinDisplay', ''); }
        function submitAuth() {
            if(state.tempAuth.length < 4) return;
            if (state.authMode === 'login') {
                if(!state.pin) { state.pin = state.tempAuth; save(); unlock(); }
                else if(state.tempAuth === state.pin) unlock();
                else { showDialog("éŒ¯èª¤", "å¯†ç¢¼ä¸æ­£ç¢º", 'error'); clearAuth(); }
            } else if (state.authMode === 'reset_tx') {
                if(state.tempAuth === state.pin) {
                    document.getElementById('authScreen').classList.add('hidden');
                    showDialog("ç¢ºå®šåˆªé™¤ï¼Ÿ", "æ­¤æ“ä½œç„¡æ³•æ¢å¾©æ‰€æœ‰å¸³ç›®", 'info', 'ç¢ºå®šåˆªé™¤', () => { state.transactions = []; save(); renderUI(); renderHomeRecords(); showDialog("å·²æ¸…é™¤", "è³‡æ–™å·²å…¨æ•¸åˆªé™¤", 'success'); });
                } else { showDialog("é©—è­‰å¤±æ•—", "å¯†ç¢¼éŒ¯èª¤", 'error'); clearAuth(); }
            }
        }
        function unlock() { document.getElementById('authScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); }
        function updateDots(id, val) {
            const dots = document.getElementById(id).children;
            for(let i=0; i<4; i++) dots[i].className = i < val.length ? 'pin-dot filled' : 'pin-dot';
        }

        // --- æ›´æ”¹å¯†ç¢¼ ---
        function openPinModal() { state.changePinStep = 1; state.changePinInput = ''; updateChangePinUI(); document.getElementById('changePinModal').classList.remove('hidden'); }
        function closePinModal() { document.getElementById('changePinModal').classList.add('hidden'); }
        function inputChangePin(n) { if(state.changePinInput.length < 4) { state.changePinInput += n; updateDots('changePinDisplay', state.changePinInput); } }
        function clearChangePin() { state.changePinInput = ''; updateDots('changePinDisplay', ''); }
        function updateChangePinUI() {
            const title = document.getElementById('changePinTitle');
            const sub = document.getElementById('changePinSub');
            const btn = document.getElementById('changePinActionBtn');
            clearChangePin();
            if(state.changePinStep === 1) { title.innerText = "é©—è­‰èˆŠå¯†ç¢¼"; sub.innerText = "è«‹è¼¸å…¥ç•¶å‰çš„ 4 ä½æ•¸å­—"; btn.innerText = "ä¸‹ä¸€æ­¥"; }
            else if(state.changePinStep === 2) { title.innerText = "è¨­ç½®æ–°å¯†ç¢¼"; sub.innerText = "è«‹è¼¸å…¥æ–°çš„ 4 ä½æ•¸å­—"; btn.innerText = "ç¢ºèª"; }
            else if(state.changePinStep === 3) { title.innerText = "å†æ¬¡ç¢ºèª"; sub.innerText = "è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼ä»¥ç¢ºèª"; btn.innerText = "å®Œæˆæ›´æ–°"; }
        }
        function submitChangePinStep() {
            if(state.changePinInput.length < 4) return;
            if(state.changePinStep === 1) {
                if(state.changePinInput === state.pin) { state.changePinStep = 2; updateChangePinUI(); }
                else { showDialog("éŒ¯èª¤", "èˆŠå¯†ç¢¼ä¸æ­£ç¢º", "error"); clearChangePin(); }
            } else if(state.changePinStep === 2) {
                state.tempNewPin1 = state.changePinInput; state.changePinStep = 3; updateChangePinUI();
            } else if(state.changePinStep === 3) {
                if(state.changePinInput === state.tempNewPin1) { state.pin = state.changePinInput; save(); closePinModal(); showDialog("æ›´æ–°æˆåŠŸ", "å¯†ç¢¼å·²æ›´æ–°", "success"); }
                else { showDialog("ä¸åŒ¹é…", "å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´", "error"); state.changePinStep = 2; updateChangePinUI(); }
            }
        }

        // --- é¡åˆ¥èˆ‡é¡è‰²ç®¡ç† ---
        function openCategoryManage() { document.getElementById('categoryManageModal').classList.remove('hidden'); renderCategoryManageList(); }
        function closeCategoryManage() { document.getElementById('categoryManageModal').classList.add('hidden'); updateCategoryGrid(); }
        function toggleManageType(t) {
            state.manageType = t;
            const tabs = { expense: 'manageTabEx', income: 'manageTabIn' };
            Object.keys(tabs).forEach(k => {
                document.getElementById(tabs[k]).className = k===t ? "px-4 py-2 rounded-lg text-[10px] font-black bg-white shadow-sm" : "px-4 py-2 rounded-lg text-[10px] font-black text-slate-400";
            });
            renderCategoryManageList();
        }
        function renderCategoryManageList() {
            const list = document.getElementById('catManageList');
            const cats = state.categories[state.manageType];
            list.innerHTML = cats.map((c, index) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <div onclick="document.getElementById('colorInput-${index}').click()" class="w-8 h-8 rounded-full border-2 border-white shadow-sm cursor-pointer relative" style="background-color: ${c.color}">
                            <input type="color" id="colorInput-${index}" class="color-input" value="${c.color}" onchange="updateCatColor('${state.manageType}', ${index}, this.value)">
                        </div>
                        <span class="font-black text-sm">${c.name}</span>
                    </div>
                    <button onclick="removeCategory('${state.manageType}', ${index})" class="text-red-400 p-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function updateCatColor(type, idx, val) { state.categories[type][idx].color = val; save(); renderCategoryManageList(); }
        function addNewCategory() {
            const input = document.getElementById('newCatInput');
            const name = input.value.trim();
            if(!name) return;
            state.categories[state.manageType].push({ name, color: '#94a3b8' });
            input.value = ''; save(); renderCategoryManageList();
        }
        function removeCategory(type, index) { state.categories[type].splice(index, 1); save(); renderCategoryManageList(); }

        // --- å ±è¡¨åŠŸèƒ½ ---
        function initChart() {
            const ctx = document.getElementById('expenseChart');
            if(!ctx) return;
            const expenses = state.transactions.filter(t => t.amount < 0);
            if(expenses.length === 0) {
                if(chartInstance) chartInstance.destroy();
                document.getElementById('noDataText').classList.remove('hidden');
                document.getElementById('chartLegend').innerHTML = '';
                return;
            }
            document.getElementById('noDataText').classList.add('hidden');
            const catMap = {};
            expenses.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + Math.abs(e.amount); });
            const labels = Object.keys(catMap); const data = Object.values(catMap);
            const colors = labels.map(l => { const found = state.categories.expense.find(c => c.name === l); return found ? found.color : '#cbd5e1'; });
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 10 }] },
                options: { cutout: '75%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
            });
            const total = data.reduce((a,b)=>a+b, 0);
            document.getElementById('chartLegend').innerHTML = labels.map((l, i) => `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${colors[i]}"></div><span>${l}</span></div>
                    <span class="text-slate-400">${Math.round(data[i]/total*100)}%</span>
                </div>
            `).join('');
        }

        // --- æ ¸å¿ƒ UI ---
        function switchPage(p) {
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
            document.getElementById(`nav-${p}`).classList.add('active');
            if(p === 'analysis') setTimeout(initChart, 50);
            lucide.createIcons();
        }

        function renderUI() {
            let total = state.transactions.reduce((a,c)=>a+c.amount,0);
            let cash = state.transactions.filter(t=>t.account==='cash').reduce((a,c)=>a+c.amount,0);
            let card = state.transactions.filter(t=>t.account==='card').reduce((a,c)=>a+c.amount,0);
            
            document.getElementById('totalBalance').innerText = `$ ${total.toLocaleString()}`;
            document.getElementById('balance-cash').innerText = `$ ${cash.toLocaleString()}`;
            document.getElementById('balance-card').innerText = `$ ${card.toLocaleString()}`;
            document.getElementById('allIncome').innerText = `$ ${state.transactions.filter(t=>t.amount>0).reduce((a,c)=>a+c.amount,0).toLocaleString()}`;
            document.getElementById('allExpense').innerText = `$ ${Math.abs(state.transactions.filter(t=>t.amount<0).reduce((a,c)=>a+c.amount,0)).toLocaleString()}`;
        }

        function renderHomeRecords() {
            const list = document.getElementById('homeTransactionList');
            document.getElementById('txCount').innerText = state.transactions.length;
            const groups = {}; state.transactions.forEach(t=>{ if(!groups[t.date])groups[t.date]=[]; groups[t.date].push(t); });
            list.innerHTML = Object.keys(groups).sort().reverse().map(d => `
                <div class="space-y-3">
                    <div class="date-divider py-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">${d}</div>
                    ${groups[d].map(t => {
                        const catInfo = [...state.categories.expense, ...state.categories.income].find(c => c.name === t.category);
                        const color = catInfo ? catInfo.color : '#000';
                        return `
                        <div class="glass p-5 rounded-[2rem] flex justify-between items-center shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-xs font-black text-white" style="background-color: ${color}">${t.category[0]}</div>
                                <div>
                                    <p class="font-black text-sm">${t.category}</p>
                                    <p class="text-[9px] opacity-40 font-black uppercase">${t.account==='cash'?'ç¾é‡‘':'å¡ç‰‡'}</p>
                                </div>
                            </div>
                            <p class="font-black-bold text-lg ${t.amount>0?'text-emerald-500':'text-slate-800'}">${t.amount>0?'+':'-'} $ ${Math.abs(t.amount).toLocaleString()}</p>
                        </div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        // --- è¨˜å¸³é‚è¼¯ ---
        function openRecordModal() {
            const firstCat = state.categories.expense[0]?.name || 'å…¶ä»–';
            state.currentRec = { id: null, type: 'expense', account: 'cash', category: firstCat, expr: '0', date: new Date().toISOString().split('T')[0] };
            setDate(state.currentRec.date); setAccount('cash'); updateCalcUI(); updateCategoryGrid();
            document.getElementById('recordModal').classList.remove('hidden');
        }
        function closeRecordModal() { document.getElementById('recordModal').classList.add('hidden'); }
        function setRecType(t) { 
            state.currentRec.type = t; 
            const tabs = { expense: 'tabEx', income: 'tabIn' };
            Object.keys(tabs).forEach(k => { document.getElementById(tabs[k]).className = k===t ? "px-8 py-3 rounded-xl text-xs font-black bg-white shadow-sm transition-all" : "px-8 py-3 rounded-xl text-xs font-black text-slate-400 transition-all"; });
            state.currentRec.category = state.categories[t][0]?.name || 'å…¶ä»–';
            updateCategoryGrid(); 
        }
        function updateCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            const cats = state.categories[state.currentRec.type];
            grid.innerHTML = cats.map(c => `
                <button onclick="state.currentRec.category='${c.name}';updateCategoryGrid()" class="category-chip ${state.currentRec.category===c.name?'bg-black text-white':''}" style="${state.currentRec.category===c.name?'':'color:'+c.color}">
                    ${c.name}
                </button>
            `).join('');
        }
        function handleMainSubmit() {
            try {
                const val = eval(state.currentRec.expr); if(!val || val <= 0) return;
                state.transactions.unshift({ ...state.currentRec, amount: state.currentRec.type==='expense' ? -val : val, id: Date.now() });
                save(); closeRecordModal(); renderUI(); renderHomeRecords();
            } catch(e) { showDialog("éŒ¯èª¤", "ç®—å¼æœ‰èª¤", "error"); }
        }

        // --- è¡Œäº‹æ›†èˆ‡é‹ç®— ---
        function openCalendar() { document.getElementById('calendarModal').classList.remove('hidden'); renderCalendar(); }
        function closeCalendar() { document.getElementById('calendarModal').classList.add('hidden'); }
        function renderCalendar() {
            const daysContainer = document.getElementById('calendarDays');
            const year = state.viewDate.getFullYear(); const month = state.viewDate.getMonth();
            document.getElementById('calendarMonthStr').innerText = `${year}å¹´ ${month+1}æœˆ`;
            daysContainer.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) daysContainer.innerHTML += `<div class="calendar-day other-month"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                daysContainer.innerHTML += `<div onclick="setDate('${ds}');closeCalendar()" class="calendar-day ${ds===state.currentRec.date?'active':''}">${i}</div>`;
            }
        }
        function changeMonth(d) { state.viewDate.setMonth(state.viewDate.getMonth()+d); renderCalendar(); }
        function setDate(d) { state.currentRec.date = d; document.getElementById('dateText').innerText = d.replace(/-/g, '/'); }
        function calcInput(v) { state.currentRec.expr = state.currentRec.expr==='0'?v:state.currentRec.expr+v; updateCalcUI(); }
        function calcOp(o) { state.currentRec.expr += o; updateCalcUI(); }
        function calcClearAll() { state.currentRec.expr = '0'; updateCalcUI(); }
        function calcBackspace() { state.currentRec.expr = state.currentRec.expr.slice(0,-1) || '0'; updateCalcUI(); }
        function updateCalcUI() { document.getElementById('calcDisplay').innerText = state.currentRec.expr; }
        function setAccount(a) { 
            state.currentRec.account = a;
            ['cash','card'].forEach(x => document.getElementById(`acc-${x}`).className = x===a ? "flex-1 py-4 rounded-2xl font-black text-xs bg-slate-900 text-white shadow-lg scale-105 transition-all" : "flex-1 py-4 rounded-2xl font-black text-xs bg-slate-100 text-slate-400 transition-all");
        }
        function exportData() {
            const blob = new Blob([JSON.stringify(state.transactions, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `finance_data.json`; a.click();
        }
        function showDialog(t, m, type='info', ct='ç¢ºå®š', onC=null) {
            const icon = document.getElementById('dialogIcon');
            icon.innerHTML = type==='success'?'<div class="w-16 h-16 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center"><i data-lucide="check-circle-2"></i></div>':'<div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center"><i data-lucide="alert-circle"></i></div>';
            document.getElementById('dialogTitle').innerText = t; document.getElementById('dialogMsg').innerText = m;
            document.getElementById('dialogConfirmBtn').onclick = () => { if(onC) onC(); closeDialog(); };
            document.getElementById('customDialog').classList.remove('hidden'); lucide.createIcons();
        }
        function closeDialog() { document.getElementById('customDialog').classList.add('hidden'); }
    </script>
</body>
</html>
